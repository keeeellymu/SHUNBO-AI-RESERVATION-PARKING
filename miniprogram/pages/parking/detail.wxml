<!--pages/parking/detail.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error" wx:elif="{{error}}">
    <text class="error-text">åŠ è½½å¤±è´¥</text>
    <button class="retry-btn" bindtap="retry">é‡è¯•</button>
  </view>

  <!-- åœè½¦åœºè¯¦æƒ…å†…å®¹ - æ·»åŠ è¿‡æ¸¡æ•ˆæœ -->
  <scroll-view wx:else scroll-y="true" class="detail-scroll fade-in">
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="parking-header">
      <view class="parking-name-row">
        <view class="parking-name">{{parkingDetails.name}}</view>
        <view class="favorite-btn {{isFavorite ? 'favorited' : ''}}" bindtap="toggleFavorite">
          <text class="favorite-icon">{{isFavorite ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        </view>
      </view>
      <view class="parking-meta">
        <view class="meta-item">
          <text class="meta-label">è·ç¦»:</text>
          <text class="meta-value">{{parkingDetails.distance}}</text>
        </view>
        <view class="meta-item">
          <text class="meta-label">åŒºåŸŸ:</text>
          <text class="meta-value area">{{parkingDetails.area}}</text>
        </view>
        <view class="meta-item">
          <text class="meta-label">ä»·æ ¼:</text>
          <text class="meta-value">{{parkingDetails.price}}</text>
        </view>
        <view class="meta-item">
          <text class="meta-label">è¯„åˆ†:</text>
          <text class="meta-value rating">{{parkingDetails.rating}}</text>
        </view>
      </view>
      <view class="parking-address">{{parkingDetails.address}}</view>
      <view class="parking-status">
        <text class="available-text">å¯ç”¨è½¦ä½: {{parkingDetails.availableSpaces}}/{{parkingDetails.totalSpaces}}</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’®ç»„ -->
    <view class="action-buttons">
      <view class="action-btn" bindtap="openNavigation">
        <text class="btn-text">å¯¼èˆª</text>
      </view>
      <view class="action-btn" bindtap="makePhoneCall">
        <text class="btn-text">ç”µè¯</text>
      </view>
      <!-- ä½¿ç”¨ open-type=\"share\" è°ƒç”¨ç³»ç»Ÿåˆ†äº«ï¼Œè€Œä¸æ˜¯ç›´æ¥è§¦å‘ onShareAppMessage -->
      <button class="action-btn share-btn" open-type="share">
        <text class="btn-text">åˆ†äº«</text>
      </button>
    </view>

    <!-- åœè½¦åœºè¯¦æƒ… -->
    <view class="detail-section">
      <view class="section-title">åœè½¦åœºä»‹ç»</view>
      <view class="section-content">
        <text class="parking-description">{{parkingDetails.description}}</text>
        <view class="feature-list">
          <view class="feature-item" wx:for="{{parkingDetails.features}}" wx:key="index">
            {{item}}
          </view>
        </view>
        <view class="detail-info">
          <view class="info-item">
            <text class="info-label">è¥ä¸šæ—¶é—´:</text>
            <text class="info-value">{{parkingDetails.openingHours}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">è”ç³»ç”µè¯:</text>
            <text class="info-value">{{parkingDetails.contactPhone}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¯ç”¨è½¦ä½ -->
    <view class="detail-section">
      <view class="section-title">å¯ç”¨è½¦ä½</view>
      
      <!-- åŒºåŸŸåˆ†ç»„æ˜¾ç¤º -->
      <view wx:if="{{groupedSpaces.length > 0}}" class="space-sections">
        <!-- åŒºåŸŸæ ‡é¢˜ -->
        <view class="section-headers">
          <text class="section-header">åŒºåŸŸ</text>
          <text class="section-header">å¯ç”¨/æ€»æ•°</text>
          <text class="section-header">æ“ä½œ</text>
        </view>
        
        <!-- åŒºåŸŸåˆ—è¡¨ -->
        <view class="section-list">
          <view wx:for="{{groupedSpaces}}" wx:key="sectionLabel" class="section-group">
            <!-- åŒºåŸŸä¿¡æ¯å¤´éƒ¨ -->
            <view class="section-group-header">
              <view class="section-info">
                <text class="section-name">{{item.sectionLabel}}</text>
                <text class="section-count">
                  <text class="available-count">{{item.availableSpaces}}</text>
                  <text class="total-count">/{{item.totalSpaces}}</text>
                </text>
              </view>
            </view>
            
            <!-- åŒºåŸŸå†…è½¦ä½åˆ—è¡¨ -->
            <view class="section-spaces">
              <view wx:for="{{item.spaces}}" wx:for-item="space" wx:key="id" 
                    class="space-item {{selectedSpaceId === space.id ? 'selected' : ''}} {{!space.isAvailable ? 'unavailable' : ''}}" 
                    catchtap="selectSpace" 
                    data-id="{{space.id}}"
                    data-space-info="{{space}}"
                    hover-start-time="0"
                    hover-stay-time="0"
                    hover-class="space-item-hover"
              >
                <view class="space-info">
                  <view class="space-number">{{space.number}}å·</view>
                  <view class="space-type" wx:if="{{space.type === 'EV'}}">
                    <view class="ev-badge">ç”µåŠ¨è½¦ä½</view>
                  </view>
                </view>
                <view class="space-distance">{{space.distance}}</view>
                <view class="space-status">
                  <view class="status-indicator {{space.isAvailable ? 'available' : 'unavailable'}}" 
                        wx:if="{{space.isAvailable}}">
                    å¯ç”¨
                  </view>
                  <view class="status-indicator {{space.isAvailable ? 'available' : 'unavailable'}}" 
                        wx:else>
                    å·²å 
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- æ— æ•°æ®çŠ¶æ€ -->
      <view wx:else class="no-spaces">
        <text class="no-spaces-text">æš‚æ— å¯ç”¨è½¦ä½ä¿¡æ¯</text>
      </view>
    </view>

    <!-- é¢„çº¦è¡¨å• -->
    <view class="detail-section">
      <view class="section-title">é¢„çº¦ä¿¡æ¯</view>
      <view class="booking-form">
        <!-- é¢„çº¦æ¨¡å¼é€‰æ‹© -->
        <view class="form-item">
          <text class="form-label">é¢„çº¦æ–¹å¼</text>
          <view class="mode-selector-card">
            <view class="mode-selector">
              <view class="mode-option {{bookingMode === 'immediate' ? 'active' : ''}}" 
                    bindtap="switchBookingMode" 
                    data-mode="immediate">
                <text>ç«‹å³é¢„çº¦</text>
              </view>
              <view class="mode-option {{bookingMode === 'scheduled' ? 'active' : ''}}" 
                    bindtap="switchBookingMode" 
                    data-mode="scheduled">
                <text>é€‰æ‹©æ—¶é—´</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- æ—¶é—´é€‰æ‹©ï¼ˆé€‰æ‹©æ—¶é—´æ¨¡å¼ï¼‰ -->
        <view wx:if="{{bookingMode === 'scheduled'}}" class="time-selector-group">
          <view class="form-item">
            <text class="form-label">å¼€å§‹æ—¶é—´</text>
            <picker mode="multiSelector" 
                    range="{{timeRange}}" 
                    value="{{startTimeIndex}}" 
                    bindchange="onStartTimeChange">
              <view class="time-picker">
                <text>{{startTime || 'è¯·é€‰æ‹©å¼€å§‹æ—¶é—´'}}</text>
                <text class="arrow-icon">></text>
              </view>
            </picker>
          </view>
        </view>
        
        <view class="form-item">
          <text class="form-label">è½¦ç‰Œå·</text>
          <view class="vehicle-selector" bindtap="openVehicleSelector">
            <text class="vehicle-number">{{bookingInfo.vehicleNumber || 'è¯·é€‰æ‹©è½¦ç‰Œå·'}}</text>
            <text class="arrow-icon">></text>
          </view>
        </view>
      </view>
    </view>

    <!-- è½¦ç‰Œå·é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
    <view class="vehicle-modal" wx:if="{{showVehicleSelector}}">
      <view class="modal-overlay" bindtap="closeVehicleSelector"></view>
      <view class="modal-content">
        <view class="modal-header">
          <text class="modal-title">é€‰æ‹©è½¦ç‰Œå·</text>
          <text class="modal-close" bindtap="closeVehicleSelector">Ã—</text>
        </view>
        <view class="vehicle-list">
          <view class="vehicle-item {{selectedVehicleIndex === index ? 'selected' : ''}}" 
                wx:for="{{vehicles}}" 
                wx:key="id" 
                data-index="{{index}}" 
                bindtap="selectVehicle">
            <view class="vehicle-info">
              <text class="plate-number">{{item.plateNumber}}</text>
              <text class="vehicle-type">{{item.type}}</text>
            </view>
            <text class="check-icon" wx:if="{{selectedVehicleIndex === index}}">âœ“</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨é¢„çº¦æŒ‰é’® -->
    <view class="bottom-actions">
      <button class="book-btn" bindtap="submitBooking">
        {{bookingMode === 'immediate' ? 'ç«‹å³é¢„çº¦' : 'ç¡®è®¤é¢„çº¦'}}
      </button>
    </view>
  </scroll-view>
</view>