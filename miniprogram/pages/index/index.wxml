<!-- pages/index/index.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input">
      <input 
        class="search-input-field" 
        placeholder="æœç´¢åœè½¦åœº" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearchConfirm"
        confirm-type="search"
        focus="{{isSearchFocused}}"
      />
      <text class="icon-clear" wx:if="{{searchKeyword}}" bindtap="clearSearch">Ã—</text>
      <!-- è¯­éŸ³æŒ‰é’® -->
      <view class="voice-btn" bindtap="startVoiceRecognition">
        <image class="voice-icon" src="/images/icon-robot.svg" mode="aspectFit"></image>
      </view>
    </view>
  </view>
  
  <!-- è¯­éŸ³è¯†åˆ«æµ®å±‚ -->
  <view class="voice-modal" wx:if="{{showVoiceModal}}" bindtap="closeVoiceModal">
    <view class="voice-modal-content" catchtap="stopPropagation">
      <view class="voice-header">
        <text class="voice-title">æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹</text>
        <text class="voice-close" bindtap="closeVoiceModal">Ã—</text>
      </view>
      
      <view class="voice-recording-area">
        <view class="voice-recording-circle">
          <image class="bobo-svg {{isRecording ? 'recording' : ''}}" src="/images/bobo-smile.svg" mode="aspectFit"></image>
          <text class="voice-recording-text">{{isRecording ? 'æ­£åœ¨å½•éŸ³...' : 'ç‚¹å‡»å¼€å§‹è¯´è¯'}}</text>
        </view>
        <view class="voice-recognition-text" wx:if="{{recognitionText}}">
          <text class="recognition-label">è¯†åˆ«ç»“æœï¼š</text>
          <text class="recognition-content">{{recognitionText}}</text>
        </view>
      </view>
      
      <view class="voice-controls">
        <button 
          class="voice-control-btn {{isRecording ? 'recording' : ''}}"
          bindtouchstart="onStartRecord"
          bindtouchend="onStopRecord"
          bindtouchcancel="onCancelRecord"
        >
          <text class="btn-text">{{isRecording ? 'æ¾å¼€ç»“æŸ' : 'æŒ‰ä½è¯´è¯'}}</text>
        </button>
      </view>
      
      <view class="voice-result" wx:if="{{voiceResult}}">
        <text class="result-label">å¤„ç†ç»“æœï¼š</text>
        <text class="result-message">{{voiceResult.message}}</text>
        <view class="result-actions" wx:if="{{voiceResult.commandType === 'reserve' && voiceResult.data && voiceResult.data.parkings}}">
          <button class="action-btn" bindtap="goToParkingList">æŸ¥çœ‹åœè½¦åœº</button>
        </view>
      </view>
      
      <view class="voice-tips">
        <text class="tips-title">ğŸ’¡ ä½¿ç”¨æç¤º</text>
        <text class="tip-item">â€¢ è¯´"é¢„çº¦åŒ—äº¬è·¯é™„è¿‘çš„åœè½¦åœº"</text>
        <text class="tip-item">â€¢ è¯´"é™„è¿‘æœ‰ä»€ä¹ˆåœè½¦åœº"</text>
        <text class="tip-item">â€¢ è¯´"å¯¼èˆªåˆ°åŒ—äº¬è·¯"</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢ç»“æœåˆ—è¡¨ -->
  <view class="search-results" wx:if="{{showSearchResults}}">
    <view class="search-results-header">
      <text class="results-count">æ‰¾åˆ° {{searchResults.length}} ä¸ªç»“æœ</text>
      <text class="close-results" bindtap="closeSearchResults">å…³é—­</text>
    </view>
    <scroll-view scroll-y="true" class="search-results-list">
      <view 
        wx:for="{{searchResults}}" 
        wx:key="id" 
        class="search-result-item"
        bindtap="navigateToDetail"
        data-id="{{item.id}}"
      >
        <view class="result-name">{{item.name}}</view>
        <view class="result-address">{{item.address}}</view>
        <view class="result-meta">
          <text class="result-price">Â¥{{item.hourlyRate || 0}}/å°æ—¶</text>
          <text class="result-spaces">å‰©ä½™{{item.availableSpaces || 0}}ä¸ªè½¦ä½</text>
        </view>
      </view>
      <view class="empty-search" wx:if="{{searchResults.length === 0}}">
        <text>æœªæ‰¾åˆ°ç›¸å…³åœè½¦åœº</text>
      </view>
    </scroll-view>
  </view>

  <!-- åœ°å›¾æ¨¡å— -->
  <view class="map-container">
    <map
      id="parkingMap"
      longitude="{{longitude}}"
      latitude="{{latitude}}"
      scale="15"
      markers="{{markers}}"
      covers="{{covers}}"
      show-location
      bindmarkertap="onMarkerTap"
      style="width: 100%; height: 100%;"
    >
    </map>
    
    <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
  <view class="map-controls">
    <button class="control-btn" bindtap="locateMe">
      <text class="control-icon">å®šä½</text>
    </button>
  </view>
</view>

<!-- æœ€æ–°é¢„çº¦æ¨¡å— -->
<view class="latest-reservation-section">
  <view class="reservation-header">
    <text class="reservation-title">æœ€æ–°é¢„çº¦</text>
    <text class="view-all-link" bindtap="goToReservationList">æŸ¥çœ‹å…¨éƒ¨</text>
  </view>
  
  <!-- é¢„çº¦è¯¦æƒ…å¡ç‰‡ -->
  <view class="reservation-card" wx:if="{{latestReservation}}" bindtap="navigateToReservationDetail" data-id="{{latestReservation.id}}">
    <view class="reservation-content">
      <!-- ç¼©ç•¥å›¾ -->
      <image class="reservation-thumbnail" wx:if="{{latestReservation.thumbnail}}" src="{{latestReservation.thumbnail}}" mode="aspectFill"></image>
      <view class="reservation-thumbnail-placeholder" wx:else>
        <text class="placeholder-icon">ğŸ…¿ï¸</text>
      </view>
      
      <!-- é¢„çº¦ä¿¡æ¯ -->
      <view class="reservation-info">
        <view class="reservation-header-info">
          <text class="parking-lot-name">{{latestReservation.parkingName}}</text>
          <view class="status-tag {{latestReservation.statusClass}}">
            <text class="status-text">{{latestReservation.status}}</text>
          </view>
        </view>
        
        <view class="reservation-detail-row">
          <text class="detail-text">{{latestReservation.dateTime}}</text>
        </view>
        
        <view class="reservation-detail-row">
          <text class="detail-text">è½¦ä½å·: {{latestReservation.spaceNumber || 'æœªçŸ¥è½¦ä½'}}</text>
          <text class="reservation-price">Â¥{{latestReservation.price || '0.00'}}</text>
        </view>
      </view>
    </view>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <view class="reservation-actions" catchtap="stopPropagation">
      <button class="primary-action-btn" bindtap="unlockSpace" data-id="{{latestReservation.id}}" wx:if="{{latestReservation.status === 'å¾…ä½¿ç”¨' && !latestReservation.isUnlocked}}">ç«‹å³è§£é”</button>
      <view class="primary-action-btn unlocked-btn" wx:if="{{latestReservation.isUnlocked || latestReservation.status === 'ä½¿ç”¨ä¸­'}}">å·²è§£é”</view>
      <view class="secondary-actions">
        <button class="secondary-btn cancel-btn" bindtap="cancelReservation" data-id="{{latestReservation.id}}" wx:if="{{latestReservation.status === 'å¾…ä½¿ç”¨' && !latestReservation.isUnlocked}}">å–æ¶ˆé¢„çº¦</button>
        <button class="secondary-btn navigate-btn" bindtap="navigateToParking" data-id="{{latestReservation.id}}">å¯¼èˆªå‰å¾€</button>
      </view>
    </view>
  </view>
  
  <!-- æ— é¢„çº¦çŠ¶æ€ -->
  <view class="no-reservation" wx:else>
    <text class="no-reservation-text">æš‚æ— é¢„çº¦è®°å½•</text>
    <button class="go-reserve-btn" bindtap="goToParkingList">å»é¢„çº¦</button>
  </view>
</view>

  <!-- æ¨èåœè½¦åœº -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">æ¨èåœè½¦åœº</text>
      <view class="section-more" bindtap="goToParkingList">
        <text>æŸ¥çœ‹æ›´å¤š</text>
        <text class="icon-arrow">â€º</text>
      </view>
    </view>
    
    <view class="parking-list">
      <block wx:for="{{recommendedParkings}}" wx:key="id">
        <view class="parking-item" bindtap="navigateToDetail" data-id="{{item.id}}">
          <view class="parking-info-container">
            <view class="parking-name">{{item.name}}</view>
            <view class="parking-address">{{item.address}}</view>
            <view class="parking-meta">
              <text class="distance">{{item.distance}}m</text>
              <text class="price">Â¥{{item.pricePerHour}}/å°æ—¶</text>
            </view>
          </view>
          <view class="parking-status">
            <view class="status-dot" style="background-color: {{item.availableSpaces > 0 ? '#52c41a' : '#ff4d4f'}}"></view>
            <text class="status-text">{{item.availableSpaces > 0 ? 'æœ‰è½¦ä½' : 'æ»¡ä½'}}</text>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- å…¬å‘Šæ  -->
  <view class="notice">
    <text class="notice-icon">å…¬å‘Š</text>
    <text class="notice-text">{{announcement}}</text>
  </view>
</view>